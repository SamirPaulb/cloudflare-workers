name = "web"
main = "src/index.js"
compatibility_date = "2024-12-31"
compatibility_flags = ["nodejs_compat"]
workers_dev = true

[triggers]
crons = [
  "0 0 * * sun,mon,tue,wed,thu,fri,sat",  # Daily at 00:00 UTC
  "0 0 * * sat"                            # Weekly at 00:00 UTC on Saturday
]

[[kv_namespaces]]
binding = "KV"
id = "5117dcc57e2f4229865539675b5435bb"
preview_id = "5117dcc57e2f4229865539675b5435bb"

[vars]
# Email Provider Configuration - 'gmail', 'worker-email', or 'mailerlite'
EMAIL_PROVIDER = "gmail"

# Gmail SMTP Configuration
GMAIL_HOST = "smtp.gmail.com"
GMAIL_PORT = 587

# Common Email Configuration
EMAIL_FROM_NAME = "Newsletter"

# RSS Feed Configuration
RSS_FEED_URL = "https://samirpaulb.github.io/index.xml"
USER_AGENT = "Newsletter-Bot/2.0"
FETCH_TIMEOUT_MS = 60000

# Batching and Pacing (reduced for direct SMTP)
BATCH_SIZE = 100
BATCH_WAIT_MINUTES = 5
MAX_POSTS_PER_RUN = 1

# GitHub Configuration for Backups
GITHUB_OWNER = "SamirPaulb"  # Your GitHub username
GITHUB_BACKUP_REPO = "database-backup"  # Repository for KV backups (make sure it's private)
GITHUB_BACKUP_BRANCH = "main"
GITHUB_SUBSCRIBER_BACKUP_PATH = "cloudflare-workers-kv-subscriber-backup.csv"
GITHUB_CONTACT_BACKUP_PATH = "cloudflare-workers-kv-contact-backup.csv"

# Contact Form GitHub Configuration
GITHUB_CONTACT_REPO = "cloudflare-workers"
GITHUB_CONTACT_BRANCH = "contact"
GITHUB_CONTACT_PATH = "data/contact.json"

# Cron Configuration
WEEKLY_CRON = "0 0 * * sat"

# KV Storage Prefixes
PREFIX_SUBSCRIBER = "subscriber"
PREFIX_EMAIL_QUEUE = "email-queue"
PREFIX_NEWSLETTER_SENT = "newsletter-sent"
PREFIX_NEWSLETTER_SENT_URL = "newsletter-sent-url"
PREFIX_CONTACT = "contact"
PREFIX_RATELIMIT = "ratelimit"
PREFIX_CAPTCHA = "captcha"
PREFIX_BOT = "bot"
PREFIX_BOT_DETECT = "bot-detect"

# Cleanup Configuration - Additional prefixes to keep during maintenance
KEEP_PREFIX_MAINTENANCE = "maintenance:last-"
KEEP_PREFIX_DAILY = "daily:last-"
KEEP_PREFIX_DEPLOYMENT = "deployment:"
KEEP_PREFIX_STATS = "stats:"

# Rate Limiting and Protection
RATE_LIMIT_MAX = 5  # Max form submissions per window
RATE_LIMIT_WINDOW_HOURS = 24  # Window for form submissions
GLOBAL_RATE_LIMIT_PER_MINUTE = 30  # Max requests per minute per IP
GLOBAL_RATE_LIMIT_WINDOW_MS = 60000  # Rate limit window in milliseconds (1 minute)
ABUSE_THRESHOLD = 3  # Number of rate limit hits before showing Turnstile
SUSPICIOUS_ACTIVITY_THRESHOLD = 5  # Suspicious attempts before Turnstile
STATUS_PAGE_PROTECTION = true  # Require Turnstile for status page

# URL Paths
SUBSCRIBE_WEB_PATH = "/subscribe"
SUBSCRIBE_API_PATH = "/api/subscribe"
UNSUBSCRIBE_WEB_PATH = "/unsubscribe"
UNSUBSCRIBE_API_PATH = "/api/unsubscribe"
CONTACT_WEB_PATH = "/contact"
CONTACT_API_PATH = "/api/contact"

# Site Configuration
SITE_URL = "https://samirpaulb.github.io"
UNSUBSCRIBE_URL = "https://samirpaulb.github.io/unsubscribe-newsletter/"
SITE_OWNER = "Samir P."

# Optional: extend disposable domain blocklist (CSV)
DISPOSABLE_DOMAINS = ""

# Worker Email Configuration (optional - for when using worker-email provider)
# WORKER_EMAIL_DOMAIN = "yourdomain.com"

# MailerLite Configuration (optional - for when using mailerlite provider)
MAILERLITE_API_URL = "https://connect.mailerlite.com/api"
# MAILERLITE_FROM_EMAIL = "newsletter@yourdomain.com"  # Optional, uses EMAIL_FROM_ADDRESS if not set
# MAILERLITE_GROUP_ID = ""  # Optional, group ID to add subscribers to
MAILERLITE_BATCH_SIZE = 50  # Number of recipients per batch
MAILERLITE_BATCH_DELAY = 1000  # Delay between batches in milliseconds
MAILERLITE_RATE_LIMIT = 120  # API rate limit per minute

# Workers Logs and Traces
[observability]
enabled = true

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = false
head_sampling_rate = 1
persist = true

# ===================================================================
# SECRETS TO CONFIGURE IN CLOUDFLARE DASHBOARD
# ===================================================================
# The following secrets must be set in the Cloudflare Dashboard:
#
# Required for all providers:
# 1. EMAIL_FROM_ADDRESS - From email address
# 2. EMAIL_REPLY_TO - Reply-to email address (optional)
# 3. GITHUB_TOKEN - GitHub personal access token with repo write access
# 4. TURNSTILE_SITE_KEY - Cloudflare Turnstile site key
# 5. TURNSTILE_SECRET_KEY - Cloudflare Turnstile secret key
#
# For Gmail provider:
# 6. GMAIL_USER - Gmail address for SMTP authentication
# 7. GMAIL_PASSWORD - Gmail App Password (not regular password)
#
# For Worker Email provider:
# 8. WORKER_EMAIL_FROM - Email address for worker-email provider
#
# For MailerLite provider:
# 9. MAILERLITE_API_TOKEN - MailerLite API token
#
# To set secrets, use:
# wrangler secret put SECRET_NAME
# Or configure them in the Cloudflare Dashboard under Settings > Variables
# ===================================================================